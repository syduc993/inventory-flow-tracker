<div class="bulk-form-container">
    <!-- ‚úÖ S·ª¨A L·ªñI 1: C·∫£i thi·ªán structure c·ªßa common fields section -->
    <div class="common-fields-section elevation-1">
        <h4>1. Th√¥ng tin chung</h4>
        <div class="common-fields-grid">
            <div class="form-group">
                <label class="form-label">T·ª´ kho</label>
                <div class="input-with-refresh">
                    <div id="from-depot-dropdown-container">
                        {% with field_name='from_depot', placeholder='Ch·ªçn kho ƒëi' %}
                            {% include "components/dropdowns/depot.html" %}
                        {% endwith %}
                    </div>
                    <button class="btn btn-primary" 
                            hx-post="/refresh/depots" 
                            hx-target="#from-depot-dropdown-container"
                            hx-swap="outerHTML"
                            hx-indicator="#from-depot-spinner">
                        <span class="btn-text">üîÑ</span>
                        <span id="from-depot-spinner" class="spinner htmx-indicator"></span>
                    </button>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">ƒê·∫øn kho</label>
                <div class="input-with-refresh">
                    <div id="to-depot-dropdown-container">
                        {% with field_name='to_depot', placeholder='Ch·ªçn kho ƒë·∫øn' %}
                            {% include "components/dropdowns/depot.html" %}
                        {% endwith %}
                    </div>
                    <button class="btn btn-primary" 
                            hx-post="/refresh/depots" 
                            hx-target="#to-depot-dropdown-container"
                            hx-swap="outerHTML"
                            hx-indicator="#to-depot-spinner">
                        <span class="btn-text">üîÑ</span>
                        <span id="to-depot-spinner" class="spinner htmx-indicator"></span>
                    </button>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Ng∆∞·ªùi b√†n giao</label>
                <div class="input-with-refresh">
                    <div id="employee-dropdown-container">
                        {% with field_name='handover_person', placeholder='T√¨m nh√¢n vi√™n...' %}
                            {% include "components/dropdowns/employee.html" %}
                        {% endwith %}
                    </div>
                    <button class="btn btn-primary" 
                            hx-post="/refresh/employees" 
                            hx-target="#employee-dropdown-container"
                            hx-swap="outerHTML"
                            hx-indicator="#employee-spinner">
                        <span class="btn-text">üîÑ</span>
                        <span id="employee-spinner" class="spinner htmx-indicator"></span>
                    </button>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">ƒê∆°n v·ªã v·∫≠n chuy·ªÉn</label>
                <div class="input-with-refresh">
                    <div id="transport-dropdown-container">
                        {% with field_name='transport_provider', placeholder='T√¨m ƒë∆°n v·ªã v·∫≠n chuy·ªÉn...' %}
                            {% include "components/dropdowns/transport.html" %}
                        {% endwith %}
                    </div>
                    <button class="btn btn-primary" 
                            hx-post="/refresh/transport-providers" 
                            hx-target="#transport-dropdown-container"
                            hx-swap="outerHTML"
                            hx-indicator="#transport-spinner">
                        <span class="btn-text">üîÑ</span>
                        <span id="transport-spinner" class="spinner htmx-indicator"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="bill-ids-section">
        <h4>2. Danh s√°ch Bill ID</h4>

        <div class="table-container">
            <table class="bill-table" id="billTable">
                <thead>
                    <tr>
                        <!-- ‚úÖ S·ª¨A: Thay th·∫ø inline style b·∫±ng class -->
                        <th class="th-bill-id">Bill ID</th>
                        <th class="th-quantity">SL t·∫£i</th>
                        <th class="th-status">Tr·∫°ng th√°i</th>
                        <th class="th-action">X√≥a</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Rows will be added dynamically here -->
                </tbody>
            </table>
        </div>

        <!-- ‚úÖ THAY ƒê·ªîI CH√çNH: Di chuy·ªÉn table-actions xu·ªëng d∆∞·ªõi b·∫£ng -->
        <div class="table-actions">
            <button type="button" class="btn btn-primary btn-small" onclick="addSingleBillRow()">
                ‚ûï Th√™m ID ƒë∆°n l·∫ª
            </button>
            <button type="button" 
                    id="groupedBillBtn"
                    class="btn btn-success btn-small" 
                    onclick="showGroupedBillModal()"
                    data-target="#groupedBillModal">
                üì¶ Th√™m ID g·ªôp t·∫£i
            </button>
        </div>

        <div class="total-summary">
            <strong>T·ªïng c·ªông:</strong> <span id="totalBills">0</span> Bill ID, <span id="totalLoads">0</span> bao/t·∫£i.
        </div>
    </div>

    <div class="form-actions">
        <button id="submitBtn" type="button" class="btn btn-primary" onclick="submitBulkForm()">
             <span class="btn-text">L∆∞u t·∫•t c·∫£</span>
             <span class="spinner htmx-indicator"></span>
        </button>
    </div>
    
    <div id="bulk-result-container" style="margin-top: 20px;"></div>
</div>

<!-- ‚úÖ S·ª¨A: Modal c√≥ c·ªôt Tr·∫°ng th√°i cho validation real-time, KH√îNG c√≥ c·ªôt STT -->
<div id="groupedBillModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h4>Nh·∫≠p c√°c Bill ID g·ªôp chung t·∫£i</h4>
            <span class="close" onclick="closeGroupedBillModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="table-container modal-table-container">
                <table class="modal-bill-table" id="modalBillTable">
                    <thead>
                        <tr>
                            <!-- ‚úÖ S·ª¨A: Thay th·∫ø inline style b·∫±ng class -->
                            <th class="th-bill-id">Bill ID</th>
                            <th class="th-status">Tr·∫°ng th√°i</th>
                            <th class="th-action">X√≥a</th>
                        </tr>
                    </thead>
                    <tbody id="modalBillTbody">
                        <!-- Modal rows will be added here -->
                    </tbody>
                </table>
            </div>
            <button type="button" class="btn btn-primary btn-small modal-add-row-btn" onclick="addModalBillRow()">
                ‚ûï Th√™m d√≤ng
            </button>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-success" onclick="addGroupedBillRows()">L∆∞u nh√≥m</button>
            <button type="button" class="btn btn-secondary" onclick="closeGroupedBillModal()">H·ªßy</button>
        </div>
    </div>
</div>

<!-- ‚úÖ S·ª¨A L·ªñI CH√çNH: Lo·∫°i b·ªè script conflict, ch·ªâ gi·ªØ kh·ªüi t·∫°o ƒë∆°n gi·∫£n -->
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Ch·ªâ kh·ªüi t·∫°o row ƒë·∫ßu ti√™n, kh√¥ng override modal functions
        setTimeout(() => {
            if (typeof addSingleBillRow === 'function') {
                const tbody = document.querySelector('#billTable tbody');
                if (tbody && tbody.rows.length === 0) {
                    addSingleBillRow();
                }
            }
        }, 100);
        
        // Close modal khi click backdrop
        const modal = document.getElementById('groupedBillModal');
        if (modal) {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    if (typeof closeGroupedBillModal === 'function') {
                        closeGroupedBillModal();
                    }
                }
            });
        }
        
        // Close modal v·ªõi Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const modal = document.getElementById('groupedBillModal');
                if (modal && modal.classList.contains('show')) {
                    if (typeof closeGroupedBillModal === 'function') {
                        closeGroupedBillModal();
                    }
                }
            }
        });
    });
</script>
