<!-- FILE: templates/_update_form.html -->
{% set fields = record.fields %}
{% set has_lock_values = (fields.get('S·ªë l∆∞·ª£ng bao t·∫£i nh·∫≠n') or fields.get('Ng∆∞·ªùi nh·∫≠n') or fields.get('Ng√†y nh·∫≠n h√†ng')) %}

<div class="elevation-1" style="padding: 24px; border-radius: 8px; margin: 16px 0;">
    <h3 style="color: #1976d2; margin-bottom: 16px;">üìÑ C·∫≠p nh·∫≠t Bill ID: {{ fields.ID }}</h3>

    {% if has_lock_values %}
    <div class="info" style="background-color: #fff3cd; color: #856404; border-left: 4px solid #ffc107;">
        üîí <strong>B·∫£n ghi ƒë√£ b·ªã kh√≥a.</strong><br>
        Kh√¥ng th·ªÉ ch·ªânh s·ª≠a th√¥ng tin giao h√†ng ho·∫∑c x√≥a v√¨ ƒë√£ c√≥ d·ªØ li·ªáu ·ªü c√°c tr∆∞·ªùng: {{ lock_fields }}.
    </div>
    {% endif %}

    <form hx-put="/records/{{ record.record_id }}" hx-target="#form-container" hx-swap="outerHTML">
        
        <!-- PH·∫¶N TH√îNG TIN GIAO H√ÄNG -->
        <h4 style="color: #1976d2; margin: 24px 0 16px 0; font-size: 18px;">Th√¥ng tin b√†n giao</h4>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
            <div class="form-group">
                <label for="so-luong-giao" class="form-label">S·ªë l∆∞·ª£ng bao/t·∫£i giao</label>
                <input type="number" 
                       name="S·ªë l∆∞·ª£ng bao/t·∫£i giao" 
                       id="so-luong-giao" 
                       class="form-control" 
                       value="{{ fields.get('S·ªë l∆∞·ª£ng bao/t·∫£i giao', '') }}"
                       {% if has_lock_values %}disabled{% endif %}>
            </div>
            
            <div class="form-group">
                <label class="form-label">Ng∆∞·ªùi b√†n giao</label>
                <div style="display: flex; gap: 8px; align-items: flex-start;">
                    <div class="employee-search" style="flex: 1;">
                        <input type="text" 
                               id="employee-search-giao" 
                               class="form-control employee-input" 
                               placeholder="üîç G√µ t√™n ƒë·ªÉ t√¨m nh√¢n vi√™n..."
                               autocomplete="off"
                               value="{{ fields.get('Ng∆∞·ªùi b√†n giao', '') }}"
                               {% if has_lock_values %}disabled{% endif %}>
                        <div id="employee-dropdown-giao" class="employee-dropdown">
                            {% for employee in employees %}
                            <div class="employee-option" 
                                 data-value="{{ employee.id }}" 
                                 data-name="{{ employee.name }}"
                                 data-department="{{ employee.department }}">
                                <div>
                                    <strong>{{ employee.name }}</strong> 
                                    <span style="color: #666; font-size: 12px;">({{ employee.id }})</span>
                                </div>
                                {% if employee.department and employee.department != "N/A" %}
                                    <small style="color: #888; display: block; margin-top: 2px;">
                                        üìç {{ employee.department }}
                                    </small>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                        <input type="hidden" 
                               name="Ng∆∞·ªùi b√†n giao" 
                               id="nguoi-ban-giao-hidden"
                               value="{{ fields.get('Ng∆∞·ªùi b√†n giao', '') }}">
                    </div>
                    <!-- N√∫t l√†m m·ªõi nh·ªè -->
                    <button type="button" class="btn-refresh" 
                            hx-post="/refresh-employees" 
                            hx-target="#refresh-result-giao" 
                            hx-indicator="#refresh-loading-giao"
                            title="L√†m m·ªõi danh s√°ch nh√¢n vi√™n"
                            {% if has_lock_values %}disabled{% endif %}>
                        üîÑ
                    </button>
                </div>
                <div id="refresh-result-giao"></div>
                <div id="refresh-loading-giao" class="htmx-indicator">ƒêang c·∫≠p nh·∫≠t danh s√°ch nh√¢n vi√™n...</div>
            </div>
        </div>
        
        <!-- PH·∫¶N TH√îNG TIN NH·∫¨N H√ÄNG -->
        <h4 style="color: #1976d2; margin: 24px 0 16px 0; font-size: 18px;">Th√¥ng tin nh·∫≠n h√†ng</h4>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-bottom: 24px;">
            <div class="form-group">
                <label for="so-luong-nhan" class="form-label">S·ªë l∆∞·ª£ng bao t·∫£i nh·∫≠n</label>
                <input type="number" 
                       name="S·ªë l∆∞·ª£ng bao t·∫£i nh·∫≠n" 
                       id="so-luong-nhan" 
                       class="form-control" 
                       value="{{ fields.get('S·ªë l∆∞·ª£ng bao t·∫£i nh·∫≠n', '') }}" 
                       {% if fields.get('S·ªë l∆∞·ª£ng bao t·∫£i nh·∫≠n') %}disabled{% endif %}>
            </div>
            
            <div class="form-group">
                <label class="form-label">Ng∆∞·ªùi nh·∫≠n</label>
                <div style="display: flex; gap: 8px; align-items: flex-start;">
                    <div class="employee-search" style="flex: 1;">
                        <input type="text" 
                               id="employee-search-nhan" 
                               class="form-control employee-input" 
                               placeholder="üîç G√µ t√™n ƒë·ªÉ t√¨m nh√¢n vi√™n..."
                               autocomplete="off"
                               value="{{ fields.get('Ng∆∞·ªùi nh·∫≠n', '') }}"
                               {% if fields.get('Ng∆∞·ªùi nh·∫≠n') %}disabled{% endif %}>
                        <div id="employee-dropdown-nhan" class="employee-dropdown">
                            {% for employee in employees %}
                            <div class="employee-option" 
                                 data-value="{{ employee.id }}" 
                                 data-name="{{ employee.name }}"
                                 data-department="{{ employee.department }}">
                                <div>
                                    <strong>{{ employee.name }}</strong> 
                                    <span style="color: #666; font-size: 12px;">({{ employee.id }})</span>
                                </div>
                                {% if employee.department and employee.department != "N/A" %}
                                    <small style="color: #888; display: block; margin-top: 2px;">
                                        üìç {{ employee.department }}
                                    </small>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                        <input type="hidden" 
                               name="Ng∆∞·ªùi nh·∫≠n" 
                               id="nguoi-nhan-hidden"
                               value="{{ fields.get('Ng∆∞·ªùi nh·∫≠n', '') }}">
                    </div>
                    <!-- N√∫t l√†m m·ªõi nh·ªè -->
                    <button type="button" class="btn-refresh" 
                            hx-post="/refresh-employees" 
                            hx-target="#refresh-result-nhan" 
                            hx-indicator="#refresh-loading-nhan"
                            title="L√†m m·ªõi danh s√°ch nh√¢n vi√™n"
                            {% if fields.get('Ng∆∞·ªùi nh·∫≠n') %}disabled{% endif %}>
                        üîÑ
                    </button>
                </div>
                <div id="refresh-result-nhan"></div>
                <div id="refresh-loading-nhan" class="htmx-indicator">ƒêang c·∫≠p nh·∫≠t danh s√°ch nh√¢n vi√™n...</div>
            </div>
            
            <div class="form-group">
                <label for="ngay-nhan-hang" class="form-label">Ng√†y nh·∫≠n h√†ng</label>
                <input type="date" 
                       name="Ng√†y nh·∫≠n h√†ng" 
                       id="ngay-nhan-hang" 
                       class="form-control" 
                       value="{{ format_ts(fields.get('Ng√†y nh·∫≠n h√†ng')) | slice(0, 10) if fields.get('Ng√†y nh·∫≠n h√†ng') else '' }}"
                       {% if fields.get('Ng√†y nh·∫≠n h√†ng') %}disabled{% endif %}>
            </div>
        </div>
        
        <!-- PH·∫¶N TH√îNG TIN THAM CHI·∫æU -->
        <h4 style="color: #1976d2; margin: 24px 0 16px 0; font-size: 18px;">Th√¥ng tin tham chi·∫øu (ch·ªâ ƒë·ªçc)</h4>
        
        <div style="background: #f8f9fa; padding: 16px; border-radius: 4px; margin-bottom: 24px;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                <div>
                    <strong>Ng√†y b√†n giao:</strong><br>
                    {{ format_ts(fields.get('Ng√†y b√†n giao')) if fields.get('Ng√†y b√†n giao') else 'Ch∆∞a c√≥' }}
                </div>
                <div>
                    <strong>Kho ƒëi:</strong><br>
                    {{ fields.get('Kho ƒëi', 'N/A') }}
                </div>
                <div>
                    <strong>Kho ƒë·∫øn:</strong><br>
                    {{ fields.get('Kho ƒë·∫øn', 'N/A') }}
                </div>
                <div>
                    <strong>S·ªë l∆∞·ª£ng SP (API):</strong><br>
                    {{ fields.get('S·ªë l∆∞·ª£ng', 'N/A') }}
                </div>
            </div>
        </div>
        
        <!-- C√ÅC N√öT H√ÄNH ƒê·ªòNG -->
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                {% if can_delete %}
                    <button type="button" class="btn btn-danger" 
                            hx-delete="/records/{{ record.record_id }}" 
                            hx-target="#form-container"
                            hx-swap="outerHTML"
                            hx-confirm="B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b·∫£n ghi n√†y?">
                        üóëÔ∏è X√≥a
                    </button>
                {% endif %}
            </div>
            <div>
                <button type="submit" class="btn btn-primary" {% if has_lock_values %}disabled{% endif %}>
                    üíæ L∆∞u ch·ªânh s·ª≠a
                </button>
            </div>
        </div>
    </form>
</div>

<script>
// Employee search functionality cho form update
document.addEventListener('DOMContentLoaded', function() {
    // X·ª≠ l√Ω cho c·∫£ 2 tr∆∞·ªùng: giao v√† nh·∫≠n
    ['giao', 'nhan'].forEach(function(type) {
        const searchInput = document.getElementById('employee-search-' + type);
        const dropdown = document.getElementById('employee-dropdown-' + type);
        const hiddenInput = document.getElementById('nguoi-' + (type === 'giao' ? 'ban-giao' : 'nhan') + '-hidden');
        
        if (!searchInput || !dropdown || !hiddenInput) return;

        // Show dropdown when input is focused
        searchInput.addEventListener('focus', function() {
            if (!this.disabled) {
                dropdown.style.display = 'block';
            }
        });

        // Enhanced search function - t√¨m c·∫£ t√™n v√† ph√≤ng ban
        searchInput.addEventListener('input', function() {
            if (this.disabled) return;
            
            const query = this.value.toLowerCase();
            const options = dropdown.querySelectorAll('.employee-option');
            let hasResults = false;
            
            options.forEach(option => {
                const name = option.dataset.name.toLowerCase();
                const id = option.dataset.value.toLowerCase();
                const department = option.dataset.department.toLowerCase();
                
                if (query === '' || name.includes(query) || id.includes(query) || department.includes(query)) {
                    option.style.display = 'block';
                    hasResults = true;
                } else {
                    option.style.display = 'none';
                }
            });
            
            dropdown.style.display = hasResults && query.length > 0 ? 'block' : 'none';
            
            // Clear hidden value if input is manually cleared
            if (this.value === '') {
                hiddenInput.value = '';
            }
        });

        // Handle option selection
        dropdown.addEventListener('click', function(e) {
            const option = e.target.closest('.employee-option');
            if (option && !searchInput.disabled) {
                const employeeId = option.dataset.value;
                const employeeName = option.dataset.name;
                const employeeDepartment = option.dataset.department;
                
                // Hi·ªÉn th·ªã t√™n + ph√≤ng ban trong input
                if (employeeDepartment && employeeDepartment !== "N/A") {
                    searchInput.value = `${employeeName} - ${employeeDepartment}`;
                } else {
                    searchInput.value = `${employeeName} (${employeeId})`;
                }
                hiddenInput.value = employeeId;
                dropdown.style.display = 'none';
            }
        });

        // Hide dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('#employee-search-' + type) && 
                !e.target.closest('#employee-dropdown-' + type) && 
                !e.target.closest('.btn-refresh')) {
                dropdown.style.display = 'none';
            }
        });
    });
});
</script>
