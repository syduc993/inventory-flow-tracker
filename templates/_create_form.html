<!-- 
    FORM T·∫†O M·ªöI RECORD - ƒê√É S·ª¨A TO√ÄN B·ªò XUNG ƒê·ªòT
    - T·∫•t c·∫£ IDs v√† classes ƒë√£ ƒë∆∞·ª£c th√™m prefix "form-"
    - HTMX targets ƒë√£ ƒë∆∞·ª£c t√°ch bi·ªát ho√†n to√†n
    - Kh√¥ng c√≤n xung ƒë·ªôt v·ªõi file ch√≠nh v√† component
    - TH√äM: Tr∆∞·ªùng ƒê∆°n v·ªã v·∫≠n chuy·ªÉn
-->


<div class="info">
    ‚ÑπÔ∏è Kh√¥ng t√¨m th·∫•y Bill ID. ƒê√£ t·∫£i d·ªØ li·ªáu t·ª´ API ƒë·ªÉ t·∫°o m·ªõi.
</div>


<div class="elevation-1" style="padding: 24px; border-radius: 8px; margin: 16px 0;">
    <h3 style="color: #1976d2; margin-bottom: 16px;">‚ûï Th√™m m·ªõi Bill ID: {{ api_data.ID }}</h3>
    
    <!-- FORM v·ªõi target ri√™ng bi·ªát ƒë·ªÉ tr√°nh xung ƒë·ªôt -->
    <form hx-post="/records" hx-target="#form-result-area" hx-swap="innerHTML" hx-indicator=".form-submit-btn">
        <!-- Hidden fields t·ª´ API -->
        <input type="hidden" name="ID" value="{{ api_data.ID }}">
        <input type="hidden" name="ID kho ƒëi" value="{{ api_data.get('ID kho ƒëi', '') }}">
        <input type="hidden" name="Kho ƒëi" value="{{ api_data.get('Kho ƒëi', '') }}">
        <input type="hidden" name="ID kho ƒë·∫øn" value="{{ api_data.get('ID kho ƒë·∫øn', '') }}">
        <input type="hidden" name="Kho ƒë·∫øn" value="{{ api_data.get('Kho ƒë·∫øn', '') }}">
        <input type="hidden" name="S·ªë l∆∞·ª£ng" value="{{ api_data['S·ªë l∆∞·ª£ng'] }}">


        <!-- API Info Display -->
        <div style="background: #f8f9fa; padding: 16px; border-radius: 4px; margin-bottom: 24px;">
            <div>
                <strong>üè™ Kho ƒëi:</strong><br>
                {{ api_data.get('Kho ƒëi', 'N/A') }} 
                {% if api_data.get('ID kho ƒëi') %}
                    (ID: {{ api_data.get('ID kho ƒëi') }})
                {% endif %}
            </div>
            <div style="margin-top: 12px;">
                <strong>üè™ Kho ƒë·∫øn:</strong><br>
                {{ api_data.get('Kho ƒë·∫øn', 'N/A') }}
                {% if api_data.get('ID kho ƒë·∫øn') %}
                    (ID: {{ api_data.get('ID kho ƒë·∫øn') }})
                {% endif %}
            </div>
        </div>
        
        <!-- Editable fields -->
        {% for field in creatable_fields %}
            {% if field == 'Ng∆∞·ªùi b√†n giao' %}
                <div class="form-group">
                    <label for="form-employee-search-{{ field }}" class="form-label">{{ field }}</label>
                    
                    <!-- Container cho search input v√† n√∫t refresh -->
                    <div style="display: flex; gap: 8px; align-items: flex-start;">
                        <div class="employee-dropdown-component">
                            <div class="employee-search">
                                <input type="text" 
                                    class="employee-search-input form-control" 
                                    placeholder="G√µ t√™n ho·∫∑c m√£ nh√¢n vi√™n..."
                                    autocomplete="off">
                                <input type="hidden" 
                                    class="employee-hidden-input" 
                                    name="{{ field }}" 
                                    value="{{ current_value or '' }}">
                                
                                <!-- Dropdown ·∫©n m·∫∑c ƒë·ªãnh -->
                                <div class="employee-dropdown" style="display: none;">
                                    <div class="employee-dropdown-info">
                                        <small>G√µ √≠t nh·∫•t 1 k√Ω t·ª± ƒë·ªÉ t√¨m ki·∫øm</small>
                                    </div>
                                    {% for employee in employees %}
                                    <div class="employee-option" 
                                        data-value="{{ employee.id }}" 
                                        data-name="{{ employee.name }}" 
                                        data-department="{{ employee.department or '' }}">
                                        <strong>{{ employee.name }}</strong> ({{ employee.id }})
                                        {% if employee.department %}
                                        <small>{{ employee.department }}</small>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>


                        <!-- N√∫t refresh v·ªõi target ri√™ng bi·ªát v√† class ri√™ng -->
                        <button type="button" 
                                class="btn btn-primary form-btn-refresh"
                                hx-post="/refresh-employees"
                                hx-target="#form-refresh-status"
                                hx-swap="innerHTML"
                                hx-indicator=".form-btn-refresh"
                                title="L√†m m·ªõi danh s√°ch nh√¢n vi√™n t·ª´ 1Office"
                                style="min-width: 100px;">
                            <span class="btn-text">L√†m m·ªõi</span>
                            <span class="htmx-indicator">
                                <span class="spinner"></span>
                                ƒêang t·∫£i...
                            </span>
                        </button>
                    </div>
                </div>
                
                <!-- Container ri√™ng cho refresh status c·ªßa form -->
                <div id="form-refresh-status" class="refresh-status-container">
                    <!-- K·∫øt qu·∫£ l√†m m·ªõi danh s√°ch nh√¢n vi√™n s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y -->
                </div>


            {% elif field == 'ƒê∆°n v·ªã v·∫≠n chuy·ªÉn' %}
                <!-- ‚Üê ƒê√É S·ª¨A: Tr∆∞·ªùng ƒë∆°n v·ªã v·∫≠n chuy·ªÉn v·ªõi ki·ªÉm tra transport_providers -->
                <div class="form-group">
                    <label for="form-transport-search-{{ field }}" class="form-label">{{ field }}</label>
                    
                    {% if transport_providers and transport_providers|length > 0 %}
                        <!-- Hi·ªÉn th·ªã dropdown n·∫øu c√≥ d·ªØ li·ªáu -->
                        <div style="display: flex; gap: 8px; align-items: flex-start;">
                            <div class="transport-dropdown-component">
                                <div class="transport-search">
                                    <input type="text" 
                                        class="transport-search-input form-control" 
                                        placeholder="G√µ ƒë·ªÉ t√¨m ƒë∆°n v·ªã v·∫≠n chuy·ªÉn..."
                                        autocomplete="off">
                                    <input type="hidden" 
                                        class="transport-hidden-input" 
                                        name="{{ field }}" 
                                        value="">
                                    
                                    <!-- Dropdown ·∫©n m·∫∑c ƒë·ªãnh -->
                                    <div class="transport-dropdown" style="display: none;">
                                        <div class="transport-dropdown-info">
                                            <small>G√µ √≠t nh·∫•t 1 k√Ω t·ª± ƒë·ªÉ t√¨m ki·∫øm</small>
                                        </div>
                                        {% for provider in transport_providers %}
                                        <div class="transport-option" 
                                            data-value="{{ provider.id }}" 
                                            data-name="{{ provider.name }}">
                                            <div>{{ provider.name }}</div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>


                            <!-- N√∫t refresh cho transport providers -->
                            <button type="button" 
                                    class="btn btn-primary form-btn-refresh-transport"
                                    hx-post="/refresh-transport-providers"
                                    hx-target="#form-transport-refresh-status"
                                    hx-swap="innerHTML"
                                    hx-indicator=".form-btn-refresh-transport"
                                    title="L√†m m·ªõi danh s√°ch ƒë∆°n v·ªã v·∫≠n chuy·ªÉn"
                                    style="min-width: 100px;">
                                <span class="btn-text">L√†m m·ªõi</span>
                                <span class="htmx-indicator">
                                    <span class="spinner"></span>
                                    ƒêang t·∫£i...
                                </span>
                            </button>
                        </div>
                    {% else %}
                        <!-- Fallback: Input th√¥ng th∆∞·ªùng n·∫øu kh√¥ng c√≥ d·ªØ li·ªáu -->
                        <div style="display: flex; gap: 8px; align-items: flex-start;">
                            <input type="text" 
                                   class="form-control" 
                                   name="{{ field }}" 
                                   placeholder="Nh·∫≠p ƒë∆°n v·ªã v·∫≠n chuy·ªÉn..."
                                   style="flex: 1;">
                            
                            <!-- N√∫t refresh ƒë·ªÉ t·∫£i d·ªØ li·ªáu l·∫ßn ƒë·∫ßu -->
                            <button type="button" 
                                    class="btn btn-primary form-btn-refresh-transport"
                                    hx-post="/refresh-transport-providers"
                                    hx-target="#form-transport-refresh-status"
                                    hx-swap="innerHTML"
                                    hx-indicator=".form-btn-refresh-transport"
                                    title="T·∫£i danh s√°ch ƒë∆°n v·ªã v·∫≠n chuy·ªÉn"
                                    style="min-width: 100px;">
                                <span class="btn-text">T·∫£i d·ªØ li·ªáu</span>
                                <span class="htmx-indicator">
                                    <span class="spinner"></span>
                                    ƒêang t·∫£i...
                                </span>
                            </button>
                        </div>
                        
                        <small class="text-muted">
                            ‚ö†Ô∏è Ch∆∞a c√≥ d·ªØ li·ªáu ƒë∆°n v·ªã v·∫≠n chuy·ªÉn. Nh·∫•n "T·∫£i d·ªØ li·ªáu" ƒë·ªÉ l√†m m·ªõi t·ª´ Larkbase.
                        </small>
                    {% endif %}
                </div>
                
                <!-- Container ri√™ng cho refresh status c·ªßa transport providers -->
                <div id="form-transport-refresh-status" class="refresh-status-container">
                    <!-- K·∫øt qu·∫£ l√†m m·ªõi danh s√°ch ƒë∆°n v·ªã v·∫≠n chuy·ªÉn s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y -->
                </div>
                
            {% else %}
                <!-- C√°c tr∆∞·ªùng kh√°c kh√¥ng ph·∫£i employee dropdown ho·∫∑c transport dropdown -->
                <div class="form-group">
                    <label for="form-{{ field | replace(' ', '_') | lower }}" class="form-label">{{ field }}</label>
                    <input type="{{ 'number' if 'S·ªë l∆∞·ª£ng' in field else 'text' }}" 
                           class="form-control" 
                           name="{{ field }}" 
                           id="form-{{ field | replace(' ', '_') | lower }}"
                           {% if field == 'S·ªë l∆∞·ª£ng bao/t·∫£i giao' %}value="{{ api_data['S·ªë l∆∞·ª£ng'] }}"{% endif %}
                           placeholder="{% if 'S·ªë l∆∞·ª£ng' in field %}Nh·∫≠p s·ªë l∆∞·ª£ng...{% else %}Nh·∫≠p {{ field.lower() }}...{% endif %}"
                           required>
                </div>
            {% endif %}
        {% endfor %}
        
        <!-- N√∫t submit v·ªõi class ri√™ng ƒë·ªÉ tr√°nh xung ƒë·ªôt indicator -->
        <button type="submit" class="btn btn-success form-submit-btn" hx-indicator="this">
            <span class="btn-text">‚úÖ L∆∞u th√¥ng tin</span>
            <span class="htmx-indicator">
                <span class="spinner"></span>
                ƒêang l∆∞u...
            </span>
        </button>
    </form>
    
    <!-- Khu v·ª±c hi·ªÉn th·ªã k·∫øt qu·∫£ sau khi submit form -->
    <div id="form-result-area" class="form-result-container">
        <!-- K·∫øt qu·∫£ submit form s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y -->
    </div>
</div>
